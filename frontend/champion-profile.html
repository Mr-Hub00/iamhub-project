<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAMHub - ChampionP Profile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .navbar {
            background: rgba(255,255,255,0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .logo h1 {
            font-size: 1.8em;
            font-weight: 700;
        }
        
        .nav-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .profile-header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 30px;
            align-items: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .avatar-section {
            text-align: center;
        }
        
        .avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3em;
            font-weight: bold;
            margin: 0 auto 15px;
        }
        
        .champion-badge {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #333;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-block;
        }
        
        .profile-info h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .web3-section {
            text-align: center;
        }
        
        .web3-status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .web3-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .web3-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .metamask-btn {
            background: linear-gradient(135deg, #f6851b, #e2761b);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .metamask-btn:hover {
            transform: translateY(-2px);
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .profile-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .purpose-section {
            grid-column: 1 / -1;
        }
        
        .purpose-statement {
            font-size: 1.2em;
            line-height: 1.6;
            color: #555;
            font-style: italic;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .mt-15 {
            margin-top: 15px;
        }
        .mt-20 {
            margin-top: 20px;
        }
        .mb-15 {
            margin-bottom: 15px;
        }
        #personalityTraits {
            margin-top: 10px;
        }

        #purposeTags {
            margin-top: 10px;
        }
        
        .personality-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            display: inline-block;
            margin: 5px;
        }
        
        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .skill-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
        
        .skill-name {
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .skill-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .skill-progress {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .connection-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .connection-card:hover {
            transform: translateY(-5px);
        }
        
        .connection-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin: 0 auto 10px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            min-height: 50px;
        }
        
        .tag {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            margin: 50px auto;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .close:hover {
            color: #000;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .profile-header {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .profile-grid {
                grid-template-columns: 1fr;
            }
            
            .profile-stats {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <h1>IAMHub</h1>
        </div>
        <div class="nav-actions">
            <span id="navUsername">Loading...</span>
            <a href="dashboard.html" class="btn">Dashboard</a>
            <a href="login.html" class="btn btn-secondary" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading your ChampionP profile...</p>
        </div>

        <div id="profileContent" class="hidden">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="avatar-section">
                    <div class="avatar" id="userAvatar">üë§</div>
                    <div class="champion-badge" id="roleBadge">Seeker</div>
                </div>
                
                <div class="profile-info">
                    <h1 id="displayName">Champion Profile</h1>
                    <p id="purposePreview">Defining my purpose in the community...</p>
                    <div class="profile-stats">
                        <div class="stat">
                            <div class="stat-number" id="reputationScore">0</div>
                            <div class="stat-label">Reputation</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number" id="communityRank">0</div>
                            <div class="stat-label">Rank</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number" id="connectionScore">0</div>
                            <div class="stat-label">Connections</div>
                        </div>
                    </div>
                </div>
                
                <div class="web3-section">
                    <div class="web3-status" id="web3Status">
                        <strong>Web3 Status</strong><br>
                        <span id="web3StatusText">Checking...</span>
                    </div>
                    <button class="metamask-btn" id="metamaskBtn" onclick="connectMetamask()">
                        ü¶ä Connect Metamask
                    </button>
                </div>
            </div>

            <!-- Profile Grid -->
            <div class="profile-grid">
                        <div id="purposeTags">
                            <!-- Purpose tags will be populated here -->
                        </div>
                        <strong>Focus Areas:</strong>
                        <div id="purposeTags">
                            <!-- Purpose tags will be populated here -->
                        </div>
                    </div>
                        <div id="purposeTags">
                    <button class="btn mt-20" onclick="openEditModal('purpose')">
                        Edit Purpose
                    </button>
                    <button class="btn mt-20" onclick="openEditModal('purpose')">
                        Edit Purpose
                    </button>
                </div>

                <!-- Profile Details -->
                <div class="profile-card">
                    <h3 class="card-title">üë§ Profile Details</h3>
                    <div class="form-group">
                        <strong>Bio:</strong>
                        <p id="userBio">Add your biography...</p>
                    </div>
                    <div class="form-group">
                        <strong>Location:</strong>
                        <p id="userLocation">Location not set</p>
                    </div>
                    <div class="form-group">
                        <strong>Website:</strong>
                        <p id="userWebsite">No website</p>
                    </div>
                    <button class="btn" onclick="openEditModal('profile')">Edit Profile</button>
                </div>

                <!-- Personality & Traits -->
                <div class="profile-card">
                    <h3 class="card-title">üß† Personality & Traits</h3>
                    <div class="mb-15">
                        <strong>Primary Type:</strong>
                        <div class="personality-badge" id="primaryPersonality">Explorer</div>
                        <div id="personalityTraits">
                            <!-- Traits will be populated here -->
                        </div>
                        <div id="personalityTraits">
                            <!-- Traits will be populated here -->
                        </div>
                    </div>
                    <button class="btn mt-20" onclick="openEditModal('personality')">
                        Edit Personality
                    </button>
                </div>

                <!-- Skills & Proficiency -->
                <div class="profile-card">
                    <h3 class="card-title">üöÄ Skills & Proficiency</h3>
                    <div class="skills-grid" id="skillsGrid">
                        <!-- Skills will be populated here -->
                    </div>
                    <button class="btn mt-20" onclick="openEditModal('skills')">
                        Manage Skills
                    </button>
                </div>

                    <div class="mb-15">
                        <strong>Availability:</strong>
                        <span class="personality-badge" id="availabilityStatus">Available</span>
                    </div>
                        <strong>Availability:</strong>
                        <span class="personality-badge" id="availabilityStatus">Available</span>
                    </div>
                    <div class="mb-15">
                        <strong>Interests:</strong>
                        <p id="userInterests">Add your interests...</p>
                    </div>
                    <button class="btn" onclick="loadCommunityChampions()">Discover Champions</button>
                </div>

                <!-- Web3 & Blockchain -->
                <div class="profile-card">
                    <h3 class="card-title">‚õìÔ∏è Web3 & Blockchain</h3>
                    <div class="form-group">
                        <strong>Wallet Address:</strong>
                        <p id="walletAddress">Not connected</p>
                    </div>
                    <div class="form-group">
                        <strong>NFT Count:</strong>
                        <span id="nftCount">0</span>
                    </div>
                    <div class="form-group">
                        <strong>PeaceToken Balance:</strong>
                        <span id="tokenBalance">0</span>
                    </div>
                    <div class="form-group">
                        <strong>DAO Participation:</strong>
                        <span id="daoParticipation">‚ùå Not Active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modals -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <div id="modalContent">
                <!-- Modal content will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Champions Modal -->
    <div id="championsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChampionsModal()">&times;</span>
            <h2>üèÜ Community Champions</h2>
            <div id="championsContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading champions...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api/auth';
        let currentUser = null;
        let web3 = null;
        let userAccount = null;

        // Initialize on page load
        window.addEventListener('load', async function() {
            await checkAuthentication();
            await detectMetamask();
        });

        async function checkAuthentication() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/profile/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    currentUser = result.user;
                    populateProfile();
                } else {
                    localStorage.removeItem('access_token');
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = 'login.html';
            }
        }

        function populateProfile() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('profileContent').classList.remove('hidden');

            // Basic info
            document.getElementById('navUsername').textContent = currentUser.username;
            document.getElementById('displayName').textContent = currentUser.username;
            document.getElementById('roleBadge').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            
            // Avatar (first letter of username)
            document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
            
            // Stats
            document.getElementById('reputationScore').textContent = currentUser.reputation_score || 0;
            document.getElementById('communityRank').textContent = currentUser.community_rank || 0;
            document.getElementById('connectionScore').textContent = currentUser.connection_score || 0;
            
            // Purpose
            document.getElementById('purposeStatement').textContent = currentUser.purpose_statement || 'Define your purpose and mission in the community...';
            document.getElementById('purposePreview').textContent = currentUser.purpose_statement || 'Defining my purpose...';
            populateTags('purposeTags', currentUser.purpose_tags);
            
            // Profile details
            document.getElementById('userBio').textContent = currentUser.bio || 'Add your biography...';
            document.getElementById('userLocation').textContent = currentUser.location || 'Location not set';
            document.getElementById('userWebsite').textContent = currentUser.website || 'No website';
            
            // Personality
            document.getElementById('primaryPersonality').textContent = 
                currentUser.primary_personality ? 
                currentUser.primary_personality.charAt(0).toUpperCase() + currentUser.primary_personality.slice(1) : 
                'Not set';
            populateTags('personalityTraits', currentUser.personality_traits);
            
            // Skills
            populateSkills(currentUser.skills || {});
            
            // Connections
            document.getElementById('availabilityStatus').textContent = 
                currentUser.availability_status ? 
                currentUser.availability_status.charAt(0).toUpperCase() + currentUser.availability_status.slice(1) : 
                'Available';
            document.getElementById('userInterests').textContent = currentUser.interests || 'Add your interests...';
            
            // Web3
            document.getElementById('walletAddress').textContent = currentUser.wallet_address || 'Not connected';
            document.getElementById('nftCount').textContent = currentUser.nft_count || 0;
            document.getElementById('tokenBalance').textContent = currentUser.token_balance || 0;
            document.getElementById('daoParticipation').textContent = 
                currentUser.dao_participation ? '‚úÖ Active' : '‚ùå Not Active';
                
            updateWeb3Status();
        }

        function populateTags(containerId, tagsString) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (tagsString) {
                const tags = tagsString.split(',').map(tag => tag.trim()).filter(tag => tag);
                tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'personality-badge';
                    tagElement.textContent = tag;
                    container.appendChild(tagElement);
                });
            }
        }

        function populateSkills(skills) {
            const container = document.getElementById('skillsGrid');
            container.innerHTML = '';
            
            if (Object.keys(skills).length === 0) {
                container.innerHTML = '<p>No skills added yet. Click "Manage Skills" to add some!</p>';
                return;
            }
            
            Object.entries(skills).forEach(([skill, rating]) => {
                const skillElement = document.createElement('div');
                skillElement.className = 'skill-item';
                skillElement.innerHTML = `
                    <div class="skill-name">${skill}</div>
                    <div class="skill-bar">
                        <div class="skill-progress" style="width: ${rating}%"></div>
                    </div>
                    <div style="text-align: right; margin-top: 5px; font-size: 0.9em;">${rating}%</div>
                `;
                container.appendChild(skillElement);
            });
        }

        // Metamask Integration
        async function detectMetamask() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = window.ethereum;
                document.getElementById('metamaskBtn').textContent = 'ü¶ä Connect Metamask';
                
                // Check if already connected
                try {
                    const accounts = await web3.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        updateWeb3Status(true);
                    }
                } catch (error) {
                    console.error('Error checking Metamask connection:', error);
                }
            } else {
                document.getElementById('metamaskBtn').textContent = 'ü¶ä Install Metamask';
                document.getElementById('metamaskBtn').onclick = () => {
                    window.open('https://metamask.io/download.html', '_blank');
                };
            }
        }

        async function connectMetamask() {
            if (!web3) {
                alert('Metamask not detected. Please install Metamask first.');
                return;
            }

            try {
                // Request account access
                const accounts = await web3.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                
                // Create signature message
                const message = `Connect wallet to IAMHub\nUser: ${currentUser.username}\nTimestamp: ${Date.now()}`;
                
                // Request signature
                const signature = await web3.request({
                    method: 'personal_sign',
                    params: [message, userAccount]
                });
                
                // Send to backend
                await connectWeb3Wallet(userAccount, signature, message);
                
            } catch (error) {
                console.error('Metamask connection failed:', error);
                alert('Failed to connect Metamask. Please try again.');
            }
        }

        async function connectWeb3Wallet(walletAddress, signature, message) {
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch(`${API_BASE}/web3-connect/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        wallet_address: walletAddress,
                        signature: signature,
                        message: message
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentUser.wallet_address = result.wallet_address;
                    currentUser.dao_participation = result.dao_participation;
                    currentUser.reputation_score = result.reputation_score;
                    
                    updateWeb3Status(true);
                    populateProfile();
                    alert('üöÄ Web3 wallet connected successfully! Reputation bonus awarded!');
                } else {
                    alert(result.error || 'Failed to connect wallet');
                }
            } catch (error) {
                console.error('Web3 connection error:', error);
                alert('Network error. Please try again.');
            }
        }

        function updateWeb3Status(connected = false) {
            const statusElement = document.getElementById('web3Status');
            const statusText = document.getElementById('web3StatusText');
            const metamaskBtn = document.getElementById('metamaskBtn');
            
            if (connected || currentUser.wallet_address) {
                statusElement.className = 'web3-status web3-connected';
                statusText.textContent = '‚úÖ Connected';
                metamaskBtn.textContent = 'ü¶ä Connected';
                metamaskBtn.disabled = true;
                metamaskBtn.style.opacity = '0.6';
            } else {
                statusElement.className = 'web3-status web3-disconnected';
                statusText.textContent = '‚ùå Not Connected';
            }
        }

        // Modal functions
        function openEditModal(section) {
            const modal = document.getElementById('editModal');
            const content = document.getElementById('modalContent');
            
            // Create form based on section
            let formHTML = '';
            
            switch(section) {
                case 'purpose':
                    formHTML = `
                        <h2>üéØ Edit Purpose & Mission</h2>
                        <form onsubmit="updateProfile(event, 'purpose')">
                            <div class="form-group">
                                <label>Purpose Statement</label>
                                <textarea name="purpose_statement" rows="4" placeholder="What drives you in this community?">${currentUser.purpose_statement || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Focus Areas (comma-separated)</label>
                                <input type="text" name="purpose_tags" placeholder="peace, innovation, art" value="${currentUser.purpose_tags || ''}">
                            </div>
                            <button type="submit" class="btn">Update Purpose</button>
                        </form>
                    `;
                    break;
                case 'profile':
                    formHTML = `
                        <h2>üë§ Edit Profile Details</h2>
                        <form onsubmit="updateProfile(event, 'profile')">
                            <div class="form-group">
                                <label>Bio</label>
                                <textarea name="bio" rows="4" placeholder="Tell us about yourself...">${currentUser.bio || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Location</label>
                                <input type="text" name="location" placeholder="City, Country" value="${currentUser.location || ''}">
                            </div>
                            <div class="form-group">
                                <label>Website</label>
                                <input type="url" name="website" placeholder="https://yoursite.com" value="${currentUser.website || ''}">
                            </div>
                            <div class="form-group">
                                <label>Avatar URL</label>
                                <input type="url" name="avatar_url" placeholder="https://image-url.com" value="${currentUser.avatar_url || ''}">
                            </div>
                            <button type="submit" class="btn">Update Profile</button>
                        </form>
                    `;
                    break;
                case 'personality':
                    formHTML = `
                        <h2>üß† Edit Personality & Traits</h2>
                        <form onsubmit="updateProfile(event, 'personality')">
                            <div class="form-group">
                                <label>Primary Personality</label>
                                <select name="primary_personality">
                                    <option value="">Select...</option>
                                    <option value="innovator" ${currentUser.primary_personality === 'innovator' ? 'selected' : ''}>Innovator</option>
                                    <option value="collaborator" ${currentUser.primary_personality === 'collaborator' ? 'selected' : ''}>Collaborator</option>
                                    <option value="mentor" ${currentUser.primary_personality === 'mentor' ? 'selected' : ''}>Mentor</option>
                                    <option value="explorer" ${currentUser.primary_personality === 'explorer' ? 'selected' : ''}>Explorer</option>
                                    <option value="peacemaker" ${currentUser.primary_personality === 'peacemaker' ? 'selected' : ''}>Peacemaker</option>
                                    <option value="visionary" ${currentUser.primary_personality === 'visionary' ? 'selected' : ''}>Visionary</option>
                                    <option value="technologist" ${currentUser.primary_personality === 'technologist' ? 'selected' : ''}>Technologist</option>
                                    <option value="artist" ${currentUser.primary_personality === 'artist' ? 'selected' : ''}>Artist</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Additional Traits (comma-separated)</label>
                                <input type="text" name="personality_traits" placeholder="creative, analytical, empathetic" value="${currentUser.personality_traits || ''}">
                            </div>
                            <div class="form-group">
                                <label>Availability Status</label>
                                <select name="availability_status">
                                    <option value="available" ${currentUser.availability_status === 'available' ? 'selected' : ''}>Available</option>
                                    <option value="busy" ${currentUser.availability_status === 'busy' ? 'selected' : ''}>Busy</option>
                                    <option value="focused" ${currentUser.availability_status === 'focused' ? 'selected' : ''}>Focused</option>
                                    <option value="away" ${currentUser.availability_status === 'away' ? 'selected' : ''}>Away</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Interests (comma-separated)</label>
                                <input type="text" name="interests" placeholder="blockchain, art, music" value="${currentUser.interests || ''}">
                            </div>
                            <button type="submit" class="btn">Update Personality</button>
                        </form>
                    `;
                    break;
                case 'skills':
                    const skills = currentUser.skills || {};
                    let skillsHTML = '';
                    Object.entries(skills).forEach(([skill, rating]) => {
                        skillsHTML += `
                            <div class="form-group">
                                <label>${skill}</label>
                                <input type="range" min="0" max="100" value="${rating}" onchange="updateSkillDisplay(this, '${skill}')">
                                <span id="skill-${skill}-display">${rating}%</span>
                                <button type="button" onclick="removeSkill('${skill}')" class="btn btn-secondary" style="margin-left: 10px;">Remove</button>
                            </div>
                        `;
                    });
                    
                    formHTML = `
                        <h2>üöÄ Manage Skills & Proficiency</h2>
                        <div id="existingSkills">${skillsHTML}</div>
                        <div class="form-group">
                            <label>Add New Skill</label>
                            <input type="text" id="newSkillName" placeholder="Skill name">
                            <input type="range" id="newSkillRating" min="0" max="100" value="50" onchange="document.getElementById('newSkillDisplay').textContent = this.value + '%'">
                            <span id="newSkillDisplay">50%</span>
                            <button type="button" onclick="addSkill()" class="btn">Add Skill</button>
                        </div>
                        <button type="button" onclick="saveSkills()" class="btn btn-success">Save All Skills</button>
                    `;
                    break;
            }
            
            content.innerHTML = formHTML;
            modal.style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        async function updateProfile(event, section) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch(`${API_BASE}/update-profile/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Update current user data
                    Object.keys(data).forEach(key => {
                        currentUser[key] = data[key];
                    });
                    
                    populateProfile();
                    closeEditModal();
                    alert('Profile updated successfully! üéâ');
                } else {
                    alert(result.error || 'Failed to update profile');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Network error. Please try again.');
            }
        }

        // Skills management
        let tempSkills = {};

        function updateSkillDisplay(slider, skillName) {
            document.getElementById(`skill-${skillName}-display`).textContent = slider.value + '%';
            tempSkills[skillName] = parseInt(slider.value);
        }

        function addSkill() {
            const name = document.getElementById('newSkillName').value.trim();
            const rating = parseInt(document.getElementById('newSkillRating').value);
            
            if (!name) {
                alert('Please enter a skill name');
                return;
            }
            
            tempSkills[name] = rating;
            
            const skillsContainer = document.getElementById('existingSkills');
            const skillHTML = `
                <div class="form-group">
                    <label>${name}</label>
                    <input type="range" min="0" max="100" value="${rating}" onchange="updateSkillDisplay(this, '${name}')">
                    <span id="skill-${name}-display">${rating}%</span>
                    <button type="button" onclick="removeSkill('${name}')" class="btn btn-secondary" style="margin-left: 10px;">Remove</button>
                </div>
            `;
            skillsContainer.insertAdjacentHTML('beforeend', skillHTML);
            
            document.getElementById('newSkillName').value = '';
            document.getElementById('newSkillRating').value = 50;
            document.getElementById('newSkillDisplay').textContent = '50%';
        }

        function removeSkill(skillName) {
            delete tempSkills[skillName];
            // Remove from DOM
            event.target.closest('.form-group').remove();
        }

        async function saveSkills() {
            // Collect all current skills from the form
            const skillInputs = document.querySelectorAll('#existingSkills input[type="range"]');
            const allSkills = {...tempSkills};
            
            skillInputs.forEach(input => {
                const label = input.closest('.form-group').querySelector('label').textContent;
                allSkills[label] = parseInt(input.value);
            });
            
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch(`${API_BASE}/update-skills/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ skills: allSkills })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentUser.skills = result.skills;
                    populateProfile();
                    closeEditModal();
                    alert('Skills updated successfully! üöÄ');
                } else {
                    alert(result.error || 'Failed to update skills');
                }
            } catch (error) {
                console.error('Skills update error:', error);
                alert('Network error. Please try again.');
            }
        }

        // Community Champions
        async function loadCommunityChampions() {
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch(`${API_BASE}/champions/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayChampions(result.champions);
                } else {
                    alert(result.error || 'Failed to load champions');
                }
            } catch (error) {
                console.error('Champions loading error:', error);
                alert('Network error. Please try again.');
            }
        }

        function displayChampions(champions) {
            const modal = document.getElementById('championsModal');
            const content = document.getElementById('championsContent');
            
            if (champions.length === 0) {
                content.innerHTML = '<p>No champions found. Be the first to reach champion status!</p>';
            } else {
                const championsHTML = champions.map(champion => `
                    <div class="connection-card">
                        <div class="connection-avatar">${champion.username.charAt(0).toUpperCase()}</div>
                        <h4>${champion.username}</h4>
                        <p>${champion.role.charAt(0).toUpperCase() + champion.role.slice(1)}</p>
                        <div class="stat">
                            <div class="stat-number">${champion.reputation_score}</div>
                            <div class="stat-label">Reputation</div>
                        </div>
                        <p style="margin: 10px 0; font-size: 0.9em;">${champion.location || 'Location not set'}</p>
                        <div class="personality-badge">${champion.primary_personality || 'Explorer'}</div>
                        <p style="margin-top: 10px; font-size: 0.8em; color: #666;">${champion.interests || 'No interests listed'}</p>
                    </div>
                `).join('');
                
                content.innerHTML = `
                    <div class="connections-grid">
                        ${championsHTML}
                    </div>
                `;
            }
            
            modal.style.display = 'block';
        }

        function closeChampionsModal() {
            document.getElementById('championsModal').style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const championsModal = document.getElementById('championsModal');
            
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === championsModal) {
                closeChampionsModal();
            }
        };
    </script>
</body>
</html>
